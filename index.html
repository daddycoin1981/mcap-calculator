<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸ“ˆ Memecoin PNL Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #0b0f19;
      font-family: 'Arial Rounded MT Bold', sans-serif;
      color: #ffffff;
      text-align: center;
      padding: 30px;
    }
    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 95%;
      background-color: #121826;
    }
    th, td {
      padding: 10px;
      border: 1px solid #444;
      cursor: pointer;
    }
    th {
      background-color: #1f2a40;
      color: #00ffa3;
    }
    .loss-row { background-color: #4a1d1d; }
    canvas {
      margin-top: 40px;
      background-color: #1e1e2f;
      padding: 10px;
      border-radius: 10px;
    }
    #celebrate {
      font-size: 3em;
      color: #ffd700;
      display: none;
      animation: popper 1s ease-in-out;
    }
    @keyframes popper {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.5); opacity: 1; }
      100% { transform: scale(0.5); opacity: 0; }
    }
  </style>
</head>
<body>
  <h1>ðŸ“ˆ Memecoin PNL Calculator</h1>

  <div id="celebrate">ðŸŽ‰</div>

  <table>
    <thead>
      <tr>
        <th onclick="sortTable(0)">#</th>
        <th onclick="sortTable(1)">ðŸ“… Date</th>
        <th onclick="sortTable(2)">ðŸ’  Coin</th>
        <th onclick="sortTable(3)">ðŸ’µ Investment</th>
        <th onclick="sortTable(4)">ðŸŸ¢ Entry MCAP</th>
        <th onclick="sortTable(5)">ðŸ”´ Exit MCAP</th>
        <th onclick="sortTable(6)">ðŸ’° Profit ($)</th>
        <th onclick="sortTable(7)">ðŸ“ˆ Profit (%)</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="historyBody">
      <!-- Trade rows will be injected here -->
    </tbody>
  </table>

  <canvas id="profitChart" height="100"></canvas>

  <script>
    let trades = JSON.parse(localStorage.getItem("trades") || "[]");
    let chart;
    let sortDir = {};

    function sortTable(colIndex) {
      const table = document.getElementById("historyBody");
      const rows = Array.from(table.rows);
      const dir = sortDir[colIndex] === 'asc' ? 'desc' : 'asc';
      sortDir[colIndex] = dir;
      rows.sort((a, b) => {
        const valA = a.cells[colIndex].innerText.replace(/[^\d.-]/g, '');
        const valB = b.cells[colIndex].innerText.replace(/[^\d.-]/g, '');
        const isNum = !isNaN(valA) && !isNaN(valB);
        const result = isNum ? valA - valB : a.cells[colIndex].innerText.localeCompare(b.cells[colIndex].innerText);
        return dir === 'asc' ? result : -result;
      });
      table.innerHTML = '';
      rows.forEach(row => table.appendChild(row));
    }

    function renderTrades(data) {
      const body = document.getElementById("historyBody");
      body.innerHTML = "";
      data.forEach((t, i) => {
        const row = document.createElement("tr");
        if (t.profit < 0) row.className = "loss-row";
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>${new Date(t.date).toLocaleString()}</td>
          <td>${t.coin}</td>
          <td>$${t.inv.toFixed(2)}</td>
          <td>${t.entry}</td>
          <td>${t.exit}</td>
          <td>$${t.profit.toFixed(2)}</td>
          <td>${t.percent.toFixed(2)}%</td>
          <td>
            <button onclick="deleteRow(${i})">Delete</button>
          </td>
        `;
        body.appendChild(row);
      });
    }

    function deleteRow(index) {
      trades.splice(index, 1);
      localStorage.setItem("trades", JSON.stringify(trades));
      renderTrades(trades);
      updateChart(trades);
    }

    function updateChart(data) {
      const ctx = document.getElementById("profitChart").getContext("2d");
      const labels = data.map((_, i) => `T${data.length - i}`);
      const profits = data.map(t => t.profit).reverse();
      const percents = data.map(t => t.percent.toFixed(1)).reverse();
      const tooltips = data.map(t => `$${t.profit.toFixed(2)} (${t.percent.toFixed(1)}%)`).reverse();
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Profit ($)',
            data: profits,
            borderColor: '#00ffa3',
            backgroundColor: 'rgba(0,255,163,0.1)',
            tension: 0.3,
            fill: true,
            pointBackgroundColor: profits.map(p => p >= 0 ? '#00ffa3' : '#ff4d4f')
          }]
        },
        options: {
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const idx = context.dataIndex;
                  return tooltips[idx];
                }
              }
            }
          },
          scales: {
            y: {
              title: { display: true, text: 'Profit in $' }
            },
            x: {
              title: { display: true, text: 'Trade Count (T1 = Latest)' }
            }
          }
        }
      });
    }

    renderTrades(trades);
    updateChart(trades);
  </script>
</body>
</html>
